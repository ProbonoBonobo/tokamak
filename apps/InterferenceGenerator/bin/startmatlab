#!/usr/bin/env python
import subprocess
import os
import sys
import datetime
import argparse
import matlab.engine
parser = argparse.ArgumentParser(description='Search some files')

def make_default_uuid():
    now = datetime.datetime.now()
    return now.strftime("session_%y%m%d%H%M%S")

parser.add_argument('--id', dest='session_id',metavar='<NAME>', action='store', default=make_default_uuid())
parser.add_argument('--pwd', dest='pwd', metavar='<DIRECTORY>', default=os.getcwd())
parser.add_argument('--load', dest='input_files', action='append', metavar='<FILES>', default=["/home/kz/datasets/gorgon/radar_test_16MHz_baud_45MHz_Fs_single_filter_coded.mat"])


def main(args):
    session_id = args.session_id.replace("'", "\'").replace("\"", "\'")
    if session_id in matlab.engine.find_matlab():
        sys.exit(0)
    cmd = f"""matlab -nosplash -r 'session_id = "{session_id}"; matlab.engine.shareEngine("{session_id}"); cd {args.pwd}; """
    for filepath in args.input_files:
        cmd += f"""load("{filepath}"); """
    tmp_path = f'/tmp/matlabsession_{session_id}'
    cmd += f'fid = fopen("{tmp_path}", "w"); fprintf(fid, "{datetime.datetime.now().isoformat()}"); fclose(fid);\''
    print(f"Launching new matlab instance with id '{session_id}'")
    print(f"Executing command:\n   {cmd}")
    proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    outs, errs = "", ""
    try:
        outs, errs = proc.communicate(timeout=5)
    except subprocess.TimeoutExpired:
        #proc.kill()
        #outs, errs = proc.communicate()
        pass

if __name__ == '__main__':
    args = parser.parse_args()
    print(args)
    main(args)
